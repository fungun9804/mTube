<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>myTube</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='video_page.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='general.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='comments.css') }}">
</head>
<body>
    <div class="header">
        <a href="/">mTube</a>
    </div>
    <div class="video_block">
        <video controls autoplay muted>
            <source src="{{ url_for('static', filename='videos/' + video.id|string + '.mp4') }}" type="video/mp4">
        </video>

        <div class="actions">
            <div class="like">
                <button class="like_btn" id="{{ video.id }}">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#5f6368"><path d="M840-640q32 0 56 24t24 56v80q0 7-2 15t-4 15L794-168q-9 20-30 34t-44 14H280v-520l240-238q15-15 35.5-17.5T595-888q19 10 28 28t4 37l-45 183h258Zm-480 34v406h360l120-280v-80H480l54-220-174 174ZM160-120q-33 0-56.5-23.5T80-200v-360q0-33 23.5-56.5T160-640h120v80H160v360h120v80H160Zm200-80v-406 406Z"/></svg>
                    <p>{{ video.likes }}</p>
                </button>
            </div>
            <div class="dislike">
                <button class="dislike_btn" id="{{ video.id }}">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#5f6368"><path d="M120-320q-32 0-56-24t-24-56v-80q0-7 2-15t4-15l120-282q9-20 30-34t44-14h440v520L440-82q-15 15-35.5 17.5T365-72q-19-10-28-28t-4-37l45-183H120Zm480-34v-406H240L120-480v80h360l-54 220 174-174Zm200-486q33 0 56.5 23.5T880-760v360q0 33-23.5 56.5T800-320H680v-80h120v-360H680v-80h120Zm-200 80v406-406Z"/></svg>
                    <p>{{ video.dislikes }}</p>
                </button>
            </div>
        </div>

        <h1 class="name">{{ video.name }}</h1>
        <p class="desc">{{ video.desc }}</p>
        <p class="author_name">{{ video.author_name }}</p>
    </div>

    
    <div class="comments-section">
        <h3>Комментарии (<span id="comments-count">0</span>)</h3>
        
        <div class="comment-form">
            <textarea id="comment-text" placeholder="Добавить комментарий..." rows="3"></textarea>
            <input type="text" id="comment-author" placeholder="Ваше имя (необязательно)">
            <button onclick="addComment()">Отправить</button>
        </div>

        <div class="comments-list" id="comments-list">
            <div class="loading">Загрузка комментариев...</div>
        </div>
    </div>

    <script>
       async function loadComments() {
    try {
        const response = await fetch(`/video/{{ video.id }}/comments`);
        const result = await response.json();
        
        const commentsList = document.getElementById('comments-list');
        
        if (result.success) {
            document.getElementById('comments-count').textContent = result.comments.length;
            
            if (result.comments.length === 0) {
                commentsList.innerHTML = '<div class="no-comments">Пока нет комментариев. Будьте первым!</div>';
            } else {
                commentsList.innerHTML = result.comments.map(comment => `
                    <div class="comment">
                        <div class="comment-header">
                            <span class="comment-author">${escapeHtml(comment.author)}</span>
                            <span class="comment-date">${formatDate(comment.timestamp)}</span>
                        </div>
                        <div class="comment-text">${escapeHtml(comment.text)}</div>
                    </div>
                `).join('');
            }
        } else {
            commentsList.innerHTML = '<div class="error">Ошибка загрузки комментариев</div>';
        }
    } catch (error) {
        console.error('Error loading comments:', error);
    }
}

async function addComment() {
    const text = document.getElementById('comment-text').value.trim();
    const author = document.getElementById('comment-author').value.trim() || 'Аноним';
    
    if (!text) {
        alert('Напишите комментарий');
        return;
    }

    try {
        const response = await fetch(`/video/{{ video.id }}/comment`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ text, author })
        });

        const result = await response.json();
        
        if (result.success) {
            // Очищаем форму
            document.getElementById('comment-text').value = '';
            document.getElementById('comment-author').value = '';
            
            await loadComments();
        } else {
            alert('Ошибка: ' + result.error);
        }
    } catch (error) {
        alert('Ошибка при отправке комментария');
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatDate(timestamp) {
    const date = new Date(timestamp);
    return date.toLocaleString('ru-RU');
}

document.addEventListener('DOMContentLoaded', loadComments);
    </script>
</body>

</html>
